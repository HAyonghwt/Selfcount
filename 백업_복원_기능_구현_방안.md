# 백업/복원 기능 구현 방안

## 요구사항 분석

### 현재 상태
- **기록 보관하기**: `archives/{archiveId}`에 저장 (읽기 전용, 복원 불가)
- 저장 데이터: `players`, `scores`, `courses`, `groups`, `processedByGroup`

### 요구사항
1. 현재 상태의 **모든 데이터**를 백업
2. 기록 보관 페이지에서 **복원 단추** 제공
3. 복원 시 현재 상태로 **완전히 복원**
4. 기존 기록 보관 기능과 **별도로 동작**

---

## 백업해야 할 데이터

### 1. 필수 데이터
- **`tournaments/current`**: 대회 정보, 코스 설정, 그룹 설정
- **`players`**: 선수 목록
- **`scores`**: 점수 데이터
- **`scoreLogs`**: 점수 수정 로그 (선택적, 복원 시 필요할 수 있음)

### 2. 선택적 데이터
- **`config`**: 설정 (백업하지 않아도 될 수 있음)
- **`ranks`**: 순위 데이터 (자동 계산되므로 백업 불필요)

---

## 구현 방안

### 방안 1: 별도 백업 경로 사용 (권장)

**백업 저장 경로**: `systemBackups/{backupId}`

**장점**:
- 기존 `archives`와 완전히 분리
- 기록 보관 기능과 충돌 없음
- 복원 기능만 별도로 구현

**구조**:
```typescript
interface SystemBackup {
  backupId: string; // YYYYMMDD_HHMMSS 형식
  savedAt: string; // ISO 날짜
  tournamentName: string;
  tournamentData: any; // tournaments/current 전체
  players: any;
  scores: any;
  scoreLogs?: any; // 선택적
}
```

### 방안 2: 기존 archives 확장

**기존 archives에 복원 기능 추가**

**단점**:
- 기존 기록 보관 데이터와 혼동 가능
- 기록 보관 데이터는 읽기 전용으로 설계됨

---

## 권장 구현 방안: 별도 백업 페이지

### 1. 페이지 구조

```
src/app/admin/backup/
  ├── page.tsx          # 백업/복원 메인 페이지
  └── BackupList.tsx    # 백업 목록 컴포넌트
```

### 2. 백업 기능

**위치**: `src/app/admin/backup/page.tsx`

**기능**:
1. 현재 상태의 모든 데이터 읽기
2. `systemBackups/{backupId}`에 저장
3. 백업 목록에 추가

**코드 구조**:
```typescript
const handleCreateBackup = async () => {
  // 1. 현재 데이터 읽기
  const tournamentData = await get(ref(db, 'tournaments/current'));
  const playersData = await get(ref(db, 'players'));
  const scoresData = await get(ref(db, 'scores'));
  const scoreLogsData = await get(ref(db, 'scoreLogs')); // 선택적

  // 2. 백업 ID 생성 (YYYYMMDD_HHMMSS)
  const now = new Date();
  const backupId = formatBackupId(now);

  // 3. 백업 데이터 저장
  const backupData = {
    backupId,
    savedAt: now.toISOString(),
    tournamentName: tournamentData.val()?.name || '대회',
    tournamentData: tournamentData.val(),
    players: playersData.val() || {},
    scores: scoresData.val() || {},
    scoreLogs: scoreLogsData.val() || {}, // 선택적
  };

  await set(ref(db, `systemBackups/${backupId}`), backupData);
};
```

### 3. 복원 기능

**위치**: `src/app/admin/backup/page.tsx` 또는 `src/app/admin/archive/page.tsx`

**기능**:
1. 백업 데이터 읽기
2. 현재 데이터 삭제
3. 백업 데이터로 복원

**코드 구조**:
```typescript
const handleRestoreBackup = async (backupId: string) => {
  // 1. 백업 데이터 읽기
  const backupRef = ref(db, `systemBackups/${backupId}`);
  const backupSnap = await get(backupRef);
  const backupData = backupSnap.val();

  if (!backupData) {
    toast({ title: '오류', description: '백업 데이터를 찾을 수 없습니다.' });
    return;
  }

  // 2. 확인 다이얼로그
  const confirmed = await showConfirmDialog(
    '복원 확인',
    '현재 모든 데이터가 삭제되고 백업 데이터로 복원됩니다. 계속하시겠습니까?'
  );

  if (!confirmed) return;

  // 3. 현재 데이터 삭제
  await set(ref(db, 'tournaments/current'), null);
  await set(ref(db, 'players'), null);
  await set(ref(db, 'scores'), null);
  await set(ref(db, 'scoreLogs'), null);

  // 4. 백업 데이터 복원
  await set(ref(db, 'tournaments/current'), backupData.tournamentData);
  await set(ref(db, 'players'), backupData.players);
  await set(ref(db, 'scores'), backupData.scores);
  if (backupData.scoreLogs) {
    await set(ref(db, 'scoreLogs'), backupData.scoreLogs);
  }

  toast({ title: '복원 완료', description: '백업 데이터가 성공적으로 복원되었습니다.' });
};
```

### 4. 기록 보관 페이지 통합

**옵션 1**: 기록 보관 페이지에 백업 목록 추가
- 기존 기록 보관 목록과 별도 섹션으로 표시
- 각 백업에 "복원" 단추 추가

**옵션 2**: 별도 백업 페이지 생성
- `/admin/backup` 페이지 생성
- 백업 생성 및 복원 기능 제공

---

## 구현 가능성 분석

### ✅ 가능한 항목

1. **백업 기능**: ✅ 가능
   - 모든 데이터를 읽어서 저장 가능
   - Firebase Realtime Database의 `get()` 함수 사용

2. **복원 기능**: ✅ 가능
   - 백업 데이터를 읽어서 현재 위치에 저장
   - Firebase Realtime Database의 `set()` 함수 사용

3. **별도 페이지**: ✅ 가능
   - `/admin/backup` 페이지 생성
   - 기존 코드와 충돌 없음

4. **기록 보관 페이지 통합**: ✅ 가능
   - 기록 보관 페이지에 백업 목록 섹션 추가
   - 각 백업에 복원 단추 추가

### ⚠️ 주의사항

1. **데이터 크기**:
   - 대량의 데이터 백업 시 시간이 걸릴 수 있음
   - Firebase Realtime Database의 읽기/쓰기 제한 고려

2. **복원 시 데이터 손실**:
   - 복원 시 현재 데이터가 모두 삭제됨
   - 확인 다이얼로그 필수

3. **동시성 문제**:
   - 백업/복원 중 다른 사용자가 데이터를 수정하면 충돌 가능
   - 진행 중 표시 및 잠금 권장

---

## 권장 구현 방식

### 1. 별도 백업 페이지 생성 (권장)

**장점**:
- 기존 코드와 완전히 분리
- 백업/복원 기능만 집중
- 유지보수 용이

**구조**:
```
/admin/backup
  - 백업 생성 단추
  - 백업 목록 (날짜순 정렬)
  - 각 백업에 복원 단추
  - 백업 삭제 단추 (선택적)
```

### 2. 기록 보관 페이지에 통합

**장점**:
- 한 곳에서 모든 기록 관리
- 사용자 편의성 향상

**구조**:
```
/admin/archive
  - 기록 보관 목록 (기존)
  - 백업 목록 (새로 추가)
  - 각 백업에 복원 단추
```

---

## 최종 권장안

### 별도 백업 페이지 생성 + 기록 보관 페이지 통합

1. **`/admin/backup` 페이지 생성**:
   - 백업 생성 기능
   - 백업 목록 표시
   - 복원 기능

2. **기록 보관 페이지에 백업 목록 섹션 추가**:
   - 백업 목록을 기록 보관 목록과 함께 표시
   - 각 백업에 복원 단추 추가

3. **백업 저장 경로**: `systemBackups/{backupId}`
   - 기존 `archives`와 완전히 분리
   - 충돌 없음

---

## 구현 시 고려사항

### 1. 백업 데이터 구조

```typescript
interface SystemBackup {
  backupId: string; // YYYYMMDD_HHMMSS
  savedAt: string; // ISO 날짜
  tournamentName: string;
  tournamentData: {
    name: string;
    startDate?: string;
    courses: any;
    groups: any;
    // tournaments/current의 모든 데이터
  };
  players: { [playerId: string]: any };
  scores: { [playerId: string]: { [courseId: string]: { [hole: string]: number } } };
  scoreLogs?: { [logId: string]: any }; // 선택적
}
```

### 2. 복원 프로세스

1. 사용자 확인 다이얼로그
2. 현재 데이터 삭제
3. 백업 데이터 복원
4. 완료 알림

### 3. 에러 처리

- 백업 데이터 없음
- 복원 실패
- 네트워크 오류

---

## 결론

✅ **구현 가능**: 백업/복원 기능은 완전히 구현 가능합니다.

✅ **별도 페이지 가능**: 기존 코드와 충돌 없이 별도 페이지로 구현 가능합니다.

✅ **기록 보관 페이지 통합 가능**: 기록 보관 페이지에 백업 목록을 추가하여 통합 관리 가능합니다.

**권장 구현 방식**:
1. `/admin/backup` 페이지 생성 (백업 생성 및 관리)
2. 기록 보관 페이지에 백업 목록 섹션 추가 (복원 기능)

이렇게 하면 기존 기능과 충돌 없이 백업/복원 기능을 제공할 수 있습니다.

